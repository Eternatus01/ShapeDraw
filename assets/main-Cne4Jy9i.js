var k=Object.defineProperty;var B=(r,e,t)=>e in r?k(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var i=(r,e,t)=>B(r,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const o of n)if(o.type==="childList")for(const a of o.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function t(n){const o={};return n.integrity&&(o.integrity=n.integrity),n.referrerPolicy&&(o.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?o.credentials="include":n.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(n){if(n.ep)return;n.ep=!0;const o=t(n);fetch(n.href,o)}})();class P{constructor(e){i(this,"subscribers",{mouseDown:[],mouseMove:[],mouseUp:[]});i(this,"canvas");i(this,"handleMouseDown",e=>{const{x:t,y:s}=this.getCanvasCoords(e);this.subscribers.mouseDown.forEach(n=>n(t,s))});i(this,"handleMouseMove",e=>{const{x:t,y:s}=this.getCanvasCoords(e);this.subscribers.mouseMove.forEach(n=>n(t,s))});i(this,"handleMouseUp",()=>{this.subscribers.mouseUp.forEach(e=>e())});this.canvas=e,e.addEventListener("mousedown",this.handleMouseDown),document.addEventListener("mousemove",this.handleMouseMove),document.addEventListener("mouseup",this.handleMouseUp)}subscribe(e,t){e==="mouseDown"?this.subscribers.mouseDown.push(t):e==="mouseMove"?this.subscribers.mouseMove.push(t):e==="mouseUp"&&this.subscribers.mouseUp.push(t)}unsubscribe(e,t){e==="mouseDown"?this.subscribers.mouseDown=this.subscribers.mouseDown.filter(s=>s!==t):e==="mouseMove"?this.subscribers.mouseMove=this.subscribers.mouseMove.filter(s=>s!==t):e==="mouseUp"&&(this.subscribers.mouseUp=this.subscribers.mouseUp.filter(s=>s!==t))}getCanvasCoords(e){const t=this.canvas.getBoundingClientRect();return{x:e.clientX-t.left,y:e.clientY-t.top}}}class W{constructor(e){i(this,"ctx");this.ctx=e}drawLine(e,t,s,n,o,a){this.ctx.beginPath(),this.ctx.moveTo(e,t),this.ctx.lineTo(s,n),this.ctx.strokeStyle=o,this.ctx.lineWidth=a,this.ctx.stroke()}drawRect(e,t,s,n,o,a,h){this.ctx.beginPath(),this.ctx.fillStyle=o,this.ctx.strokeStyle=h,this.ctx.lineWidth=a,this.ctx.rect(e,t,s,n),this.ctx.fill(),this.ctx.stroke()}drawCircle(e,t,s,n,o,a){this.ctx.beginPath(),this.ctx.fillStyle=n,this.ctx.strokeStyle=a,this.ctx.lineWidth=o,this.ctx.arc(e,t,s,0,Math.PI*2),this.ctx.fill(),this.ctx.stroke()}clear(){this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height)}}class x{constructor(e,t,s,n,o){i(this,"id");i(this,"x");i(this,"y");i(this,"color");i(this,"lineWidth");this.id=e,this.x=t,this.y=s,this.color=n,this.lineWidth=o}move(e,t){this.x+=e,this.y+=t}}class m extends x{constructor(t,s,n,o,a,h,c){super(t,s,n,a,h);i(this,"radius");i(this,"lineColor");i(this,"type","Circle");this.radius=o,this.lineColor=c}isPointInside(t,s){const n=t-this.x,o=s-this.y;return Math.sqrt(n*n+o*o)<=this.radius}}class l extends x{constructor(t,s,n,o,a,h,c){super(t,s,n,h,c);i(this,"x2");i(this,"y2");i(this,"type","Line");this.x2=o,this.y2=a}isPointInside(t,s){const n=Math.sqrt(Math.pow(this.x2-this.x,2)+Math.pow(this.y2-this.y,2));if(n===0)return Math.sqrt(Math.pow(t-this.x,2)+Math.pow(s-this.y,2))<=this.lineWidth;const o=Math.abs((this.y2-this.y)*t-(this.x2-this.x)*s+this.x2*this.y-this.y2*this.x)/n,a=(t-this.x)*(this.x2-this.x)+(s-this.y)*(this.y2-this.y),h=(t-this.x2)*(this.x-this.x2)+(s-this.y2)*(this.y-this.y2);return o<=this.lineWidth&&a>=0&&h>=0}move(t,s){super.move(t,s),this.x2+=t,this.y2+=s}}class y extends x{constructor(t,s,n,o,a,h,c,T){super(t,s,n,h,c);i(this,"width");i(this,"height");i(this,"lineColor");i(this,"type","Rect");this.width=o,this.height=a,this.lineColor=T}isPointInside(t,s){return t>=this.x&&t<=this.x+this.width&&s>=this.y&&s<=this.y+this.height}}class D{constructor(e){i(this,"renderer");i(this,"shapes",[]);i(this,"temporaryShape",null);i(this,"isRendering",!1);i(this,"_selectedShape",null);this.renderer=e}get selectedShape(){return this._selectedShape}setShapes(e){this.shapes=e}setTemporaryShape(e){this.temporaryShape=e}setSelectedShape(e){this._selectedShape=e}startRendering(){this.isRendering||(this.isRendering=!0,this.renderLoop())}stopRendering(){this.isRendering=!1}renderLoop(){const e=()=>{this.render(),this.isRendering&&requestAnimationFrame(e)};requestAnimationFrame(e)}render(){this.renderer.clear(),this.shapes.forEach(e=>{e instanceof y?this.renderer.drawRect(e.x,e.y,e.width,e.height,e.color,e.lineWidth,e.lineColor):e instanceof l?this.renderer.drawLine(e.x,e.y,e.x2,e.y2,e.color,e.lineWidth):e instanceof m&&this.renderer.drawCircle(e.x,e.y,e.radius,e.color,e.lineWidth,e.lineColor)}),this.temporaryShape&&(this.temporaryShape instanceof y?this.renderer.drawRect(this.temporaryShape.x,this.temporaryShape.y,this.temporaryShape.width,this.temporaryShape.height,this.temporaryShape.color,this.temporaryShape.lineWidth,this.temporaryShape.lineColor):this.temporaryShape instanceof l?this.renderer.drawLine(this.temporaryShape.x,this.temporaryShape.y,this.temporaryShape.x2,this.temporaryShape.y2,this.temporaryShape.color,this.temporaryShape.lineWidth):this.temporaryShape instanceof m&&this.renderer.drawCircle(this.temporaryShape.x,this.temporaryShape.y,this.temporaryShape.radius,this.temporaryShape.color,this.temporaryShape.lineWidth,this.temporaryShape.lineColor)),this._selectedShape&&this.drawSelectionForShape(this._selectedShape)}drawSelectionForShape(e){e instanceof y?this.renderer.drawRect(e.x-2,e.y-2,e.width+4,e.height+4,"transparent",2,"#00A0FF"):e instanceof l?this.renderer.drawLine(e.x,e.y,e.x2,e.y2,"#00A0FF",2):e instanceof m&&this.renderer.drawCircle(e.x,e.y,e.radius+2,"transparent",2,"#00A0FF")}}class F{constructor(e,t,s,n,o){i(this,"canvas");i(this,"repo");i(this,"historyManager");i(this,"renderingManager");i(this,"fileInput");i(this,"toolManager");this.canvas=e,this.repo=t,this.historyManager=s,this.renderingManager=n,this.toolManager=o,this.fileInput=document.createElement("input"),this.fileInput.type="file",this.fileInput.accept=".json",this.fileInput.style.display="none",document.body.appendChild(this.fileInput),this.fileInput.addEventListener("change",a=>{const h=a.target;h.files&&h.files.length>0&&this.importFromJSON(h.files[0])}),this.setupEventListeners()}setupEventListeners(){const e=document.getElementById("export-png");e&&e.addEventListener("click",()=>this.exportToPNG());const t=document.getElementById("export-json");t&&t.addEventListener("click",()=>this.exportToJSON());const s=document.getElementById("import-json");s&&s.addEventListener("click",()=>{this.fileInput.click()})}showToast(e,t=!1){const s=document.createElement("div");s.className=`toast-message ${t?"error":""}`,s.textContent=e,document.body.appendChild(s),setTimeout(()=>{document.body.removeChild(s)},3e3)}exportToPNG(){try{const e=this.canvas.toDataURL("image/png"),t=document.createElement("a"),s=new Date,n=`canvas_${s.getFullYear()}-${s.getMonth()+1}-${s.getDate()}_${s.getHours()}-${s.getMinutes()}.png`;t.href=e,t.download=n,t.style.display="none",document.body.appendChild(t),t.click(),setTimeout(()=>{document.body.removeChild(t)},100),this.showToast("Изображение успешно экспортировано")}catch(e){console.error("Ошибка при экспорте изображения:",e),this.showToast("Ошибка при экспорте изображения",!0)}}exportToJSON(){try{const e=this.repo.getAll(),t={version:"1.0",canvasWidth:this.canvas.width,canvasHeight:this.canvas.height,shapes:e,timestamp:new Date().toISOString()},s=JSON.stringify(t,null,2),n=new Blob([s],{type:"application/json"}),o=URL.createObjectURL(n),a=document.createElement("a"),h=new Date,c=`shapedraw_${h.getFullYear()}-${h.getMonth()+1}-${h.getDate()}_${h.getHours()}-${h.getMinutes()}.json`;a.href=o,a.download=c,a.style.display="none",document.body.appendChild(a),a.click(),setTimeout(()=>{document.body.removeChild(a),URL.revokeObjectURL(o)},100),this.showToast("Проект успешно сохранен")}catch(e){console.error("Ошибка при экспорте в JSON:",e),this.showToast("Не удалось сохранить проект",!0)}}createShapeFromData(e){try{switch(e.type){case"Rect":return new y(e.id,e.x||0,e.y||0,e.width||0,e.height||0,e.color||"#ffffff",e.lineWidth||1,e.lineColor||"#000000");case"Line":return new l(e.id,e.x||0,e.y||0,e.x2||0,e.y2||0,e.color||"#000000",e.lineWidth||1);case"Circle":return new m(e.id,e.x||0,e.y||0,e.radius||0,e.color||"#ffffff",e.lineWidth||1,e.lineColor||"#000000");default:return console.warn(`Неизвестный тип фигуры: ${e.type}`),null}}catch(t){return console.error("Ошибка при создании фигуры из данных:",t),null}}importFromJSON(e){const t=new FileReader;t.onload=s=>{var n;try{if(!s.target||typeof s.target.result!="string")throw new Error("Не удалось прочитать файл");const o=JSON.parse(s.target.result);if(!o.version)throw new Error("Некорректный формат файла проекта");[...this.repo.getAll()].forEach(h=>{this.repo.remove(h.id)}),o.canvasWidth&&o.canvasHeight&&(this.canvas.width=o.canvasWidth,this.canvas.height=o.canvasHeight),Array.isArray(o.shapes)&&o.shapes.forEach(h=>{if(h&&typeof h=="object"&&"type"in h){const c=this.createShapeFromData(h);c&&this.repo.add(c)}else console.warn("Пропущена фигура без свойства type:",h)}),this.historyManager.clear(),this.renderingManager.setShapes(this.repo.getAll()),this.toolManager.setActiveTool("Select"),this.showToast(`Проект успешно загружен (${((n=o.shapes)==null?void 0:n.length)||0} фигур)`)}catch(o){console.error("Ошибка при импорте из JSON:",o),this.showToast("Не удалось импортировать проект",!0)}},t.onerror=()=>{console.error("Ошибка при чтении файла"),this.showToast("Не удалось прочитать файл",!0)},t.readAsText(e)}}class H{constructor(){i(this,"shapes",new Map);i(this,"subscribers",[])}subscribe(e){this.subscribers.push(e)}notify(){this.subscribers.forEach(e=>e())}add(e){this.shapes.set(e.id,e),this.notify()}remove(e){this.shapes.delete(e),this.notify()}get(e){return this.shapes.get(e)||null}getAll(){return Array.from(this.shapes.values())}findByPoint(e,t){for(const s of this.shapes.values())if(s.isPointInside(e,t))return s;return null}}class b{constructor(e,t,s){i(this,"canvasInput");i(this,"addShape");i(this,"renderingManager");this.canvasInput=e,this.addShape=t,this.renderingManager=s}}class A extends b{constructor(t,s,n){super(t,s,n);i(this,"startX",0);i(this,"startY",0);i(this,"currentCircle",null);i(this,"handleMouseDown",(t,s)=>{this.startX=t,this.startY=s;const n=()=>`shape-${Math.random().toString(36).slice(2,9)}`;this.currentCircle=new m(n(),t,s,1,"#000000",2,"#FFFFFF"),this.renderingManager.setTemporaryShape(this.currentCircle),this.canvasInput.subscribe("mouseMove",this.handleMouseMove),this.canvasInput.subscribe("mouseUp",this.handleMouseUp)});i(this,"handleMouseMove",(t,s)=>{if(!this.currentCircle)return;const n=Math.sqrt(Math.pow(t-this.startX,2)+Math.pow(s-this.startY,2));this.currentCircle.radius=n,this.renderingManager.setTemporaryShape(this.currentCircle)});i(this,"handleMouseUp",()=>{this.currentCircle&&(Math.abs(this.currentCircle.radius)<1&&(this.currentCircle.radius=2),this.addShape.execute(this.currentCircle),this.renderingManager.setTemporaryShape(null),this.currentCircle=null)})}activate(){document.body.style.cursor="crosshair",this.canvasInput.subscribe("mouseDown",this.handleMouseDown)}deactivate(){document.body.style.cursor="default",this.canvasInput.unsubscribe("mouseDown",this.handleMouseDown),this.canvasInput.unsubscribe("mouseMove",this.handleMouseMove),this.canvasInput.unsubscribe("mouseUp",this.handleMouseUp),this.renderingManager&&this.renderingManager.setTemporaryShape(null),this.currentCircle=null}}class U extends b{constructor(t,s,n){super(t,s,n);i(this,"currentLine",null);i(this,"twoPoint",!1);i(this,"handleMouseDown",(t,s)=>{if(this.twoPoint)return;this.twoPoint=!0;const n=()=>`shape-${Math.random().toString(36).slice(2,9)}`;this.currentLine=new l(n(),t,s,0,0,"#000000",2),this.canvasInput.subscribe("mouseMove",this.handleMouseMove),this.canvasInput.subscribe("mouseDown",this.handleMouseDownTwoPoint)});i(this,"handleMouseMove",(t,s)=>{this.currentLine&&(this.currentLine.x2=t,this.currentLine.y2=s,this.renderingManager.setTemporaryShape(this.currentLine))});i(this,"handleMouseDownTwoPoint",()=>{this.currentLine&&(this.addShape.execute(this.currentLine),this.renderingManager.setTemporaryShape(null),this.canvasInput.unsubscribe("mouseMove",this.handleMouseMove),this.canvasInput.unsubscribe("mouseDown",this.handleMouseDownTwoPoint),this.currentLine=null,this.twoPoint=!1)})}activate(){document.body.style.cursor="crosshair",this.canvasInput.subscribe("mouseDown",this.handleMouseDown)}deactivate(){document.body.style.cursor="default",this.canvasInput.unsubscribe("mouseDown",this.handleMouseDown),this.canvasInput.unsubscribe("mouseMove",this.handleMouseMove),this.canvasInput.unsubscribe("mouseDown",this.handleMouseDownTwoPoint),this.renderingManager&&this.renderingManager.setTemporaryShape(null),this.currentLine=null}}class N extends b{constructor(t,s,n){super(t,s,n);i(this,"startX",0);i(this,"startY",0);i(this,"currentRect",null);i(this,"handleMouseDown",(t,s)=>{this.startX=t,this.startY=s;const n=()=>`shape-${Math.random().toString(36).slice(2,9)}`;this.currentRect=new y(n(),t,s,0,0,"#000000",2,"#FFFFFF"),this.renderingManager.setTemporaryShape(this.currentRect),this.canvasInput.subscribe("mouseMove",this.handleMouseMove),this.canvasInput.subscribe("mouseUp",this.handleMouseUp)});i(this,"handleMouseMove",(t,s)=>{this.currentRect&&(this.currentRect.width=t-this.startX,this.currentRect.height=s-this.startY,this.renderingManager.setTemporaryShape(this.currentRect))});i(this,"handleMouseUp",()=>{this.currentRect&&((Math.abs(this.currentRect.width)<5||Math.abs(this.currentRect.height)<5)&&(this.currentRect.width=100,this.currentRect.height=80),this.addShape.execute(this.currentRect),this.renderingManager.setTemporaryShape(null),this.currentRect=null)})}activate(){document.body.style.cursor="crosshair",this.canvasInput.subscribe("mouseDown",this.handleMouseDown)}deactivate(){document.body.style.cursor="default",this.canvasInput.unsubscribe("mouseDown",this.handleMouseDown),this.canvasInput.unsubscribe("mouseMove",this.handleMouseMove),this.canvasInput.unsubscribe("mouseUp",this.handleMouseUp),this.renderingManager&&this.renderingManager.setTemporaryShape(null),this.currentRect=null}}class O{constructor(e){i(this,"selectedShape",null);i(this,"renderingManager");this.renderingManager=e}selectShape(e){this.selectedShape=e,this.renderingManager.setSelectedShape(e)}clearSelection(){this.selectedShape=null,this.renderingManager.setSelectedShape(null)}getSelectedShape(){return this.selectedShape}}class ${constructor(e){i(this,"isDragging",!1);i(this,"dragOffsetX",0);i(this,"dragOffsetY",0);i(this,"startX",0);i(this,"startY",0);i(this,"moveShape");this.moveShape=e}startDrag(e,t,s){this.isDragging=!0,this.dragOffsetX=t-e.x,this.dragOffsetY=s-e.y,this.startX=e.x,this.startY=e.y}drag(e,t,s){if(!this.isDragging)return;const n=t-this.dragOffsetX,o=s-this.dragOffsetY,a=n-e.x,h=o-e.y;e.move(a,h)}endDrag(e){if(!this.isDragging)return;const t=e.x-this.startX,s=e.y-this.startY;(t!==0||s!==0)&&(e.move(-t,-s),this.moveShape.execute(e,t,s)),this.isDragging=!1}isDraggingActive(){return this.isDragging}}function w(r){return r&&typeof r=="object"&&"lineColor"in r}function f(r){return r&&typeof r=="object"&&"width"in r&&"height"in r}function v(r){return r&&typeof r=="object"&&"radius"in r}class Y{constructor(e){i(this,"changeShapeProperty");i(this,"selectionManager",null);i(this,"decimalPlaces",1);this.changeShapeProperty=e,this.setupControls()}setSelectionManager(e){this.selectionManager=e}setDecimalPlaces(e){this.decimalPlaces=e}setupControls(){const e=document.getElementById("fill-color"),t=document.getElementById("stroke-color"),s=document.getElementById("stroke-width"),n=document.getElementById("width-input"),o=document.getElementById("height-input");e&&e.addEventListener("input",()=>{const a=this.getSelectedShape();a&&this.handleFillColorChange(a,e.value)}),t&&t.addEventListener("input",()=>{const a=this.getSelectedShape();a&&this.handleStrokeColorChange(a,t.value)}),s&&s.addEventListener("input",()=>{const a=this.getSelectedShape();a&&this.handleLineWidthChange(a,parseInt(s.value))}),n&&n.addEventListener("change",()=>{const a=this.getSelectedShape();a&&this.handleWidthChange(a,parseFloat(n.value))}),o&&o.addEventListener("change",()=>{const a=this.getSelectedShape();a&&this.handleHeightChange(a,parseFloat(o.value))})}updateControls(e){if(!e){this.resetControls();return}const t=document.getElementById("fill-color"),s=document.getElementById("stroke-color"),n=document.getElementById("stroke-width"),o=document.getElementById("width-input"),a=document.getElementById("height-input");if(t&&(t.value=e.color),s&&w(e)){const h=e;s.value=h.lineColor}else s&&e instanceof l&&(s.value=e.color);if(n&&(n.value=this.formatNumber(e.lineWidth)),o){if(f(e)){const h=e;o.value=this.formatNumber(h.width)}else if(e instanceof l){const h=Math.abs(e.x2-e.x);o.value=this.formatNumber(h)}else if(v(e)){const h=e;o.value=this.formatNumber(h.radius*2)}}if(a){if(f(e)){const h=e;a.value=this.formatNumber(h.height)}else if(e instanceof l){const h=Math.abs(e.y2-e.y);a.value=this.formatNumber(h)}else if(v(e)){const h=e;a.value=this.formatNumber(h.radius*2)}}}resetControls(){const e=document.getElementById("fill-color"),t=document.getElementById("stroke-color"),s=document.getElementById("stroke-width"),n=document.getElementById("width-input"),o=document.getElementById("height-input");e&&(e.value="#000000"),t&&(t.value="#000000"),s&&(s.value="2"),n&&(n.value=""),o&&(o.value="")}handleFillColorChange(e,t){this.changeShapeProperty.changeFillColor(e,t)}handleStrokeColorChange(e,t){this.changeShapeProperty.changeStrokeColor(e,t)}handleLineWidthChange(e,t){this.changeShapeProperty.changeLineWidth(e,t)}handleWidthChange(e,t){if(e instanceof l){const s=Math.abs(e.y2-e.y);this.changeShapeProperty.changeDimensions(e,t,s)}else{const s=f(e)?e.height:v(e)?e.radius*2:0;this.changeShapeProperty.changeDimensions(e,t,s)}}handleHeightChange(e,t){if(e instanceof l){const s=Math.abs(e.x2-e.x);this.changeShapeProperty.changeDimensions(e,s,t)}else{const s=f(e)?e.width:v(e)?e.radius*2:0;this.changeShapeProperty.changeDimensions(e,s,t)}}getSelectedShape(){return this.selectionManager?this.selectionManager.getSelectedShape():null}formatNumber(e){return this.decimalPlaces<=0?Math.round(e).toString():e.toFixed(this.decimalPlaces)}}class X extends b{constructor(t,s,n,o,a,h,c){super(t,s,o);i(this,"shapesRepo");i(this,"selectionManager");i(this,"dragHandler");i(this,"propertiesPanel");i(this,"removeShape");i(this,"keydownHandler");i(this,"handleMouseDown",(t,s)=>{const n=this.selectionManager.getSelectedShape();if(n&&n.isPointInside(t,s)){this.dragHandler.startDrag(n,t,s),this.canvasInput.subscribe("mouseMove",this.handleMouseMove),this.canvasInput.subscribe("mouseUp",this.handleMouseUp),document.getElementById("canvas").style.cursor="move";return}this.selectionManager.clearSelection();const o=this.shapesRepo.getAll();for(let a=o.length-1;a>=0;a--){const h=o[a];if(h.isPointInside(t,s)){this.selectionManager.selectShape(h),this.propertiesPanel.updateControls(h);break}}});i(this,"handleMouseMove",(t,s)=>{const n=this.selectionManager.getSelectedShape();n&&(this.dragHandler.drag(n,t,s),this.renderingManager.setSelectedShape(n))});i(this,"handleMouseUp",()=>{const t=this.selectionManager.getSelectedShape();t&&this.dragHandler.endDrag(t),document.getElementById("canvas").style.cursor="default",this.canvasInput.unsubscribe("mouseMove",this.handleMouseMove),this.canvasInput.unsubscribe("mouseUp",this.handleMouseUp)});this.shapesRepo=n,this.removeShape=c,this.selectionManager=new O(o),this.dragHandler=new $(a),this.propertiesPanel=new Y(h),this.propertiesPanel.setSelectionManager(this.selectionManager),this.keydownHandler=this.handleKeyDown.bind(this)}activate(){this.canvasInput.subscribe("mouseDown",this.handleMouseDown),document.addEventListener("keydown",this.keydownHandler)}deactivate(){this.canvasInput.unsubscribe("mouseDown",this.handleMouseDown),this.selectionManager.clearSelection(),document.removeEventListener("keydown",this.keydownHandler)}handleKeyDown(t){if(t.key==="Delete"||t.keyCode===46){const s=this.selectionManager.getSelectedShape();s&&(this.removeShape.execute(s),this.selectionManager.clearSelection(),this.propertiesPanel.updateControls(null))}}}class J{constructor(e,t){i(this,"shape");i(this,"repository");this.shape=e,this.repository=t}execute(){this.repository.add(this.shape)}undo(){this.repository.remove(this.shape.id)}}class K{constructor(e,t){i(this,"shapesRepository");i(this,"historyManager");this.shapesRepository=e,this.historyManager=t}execute(e){const t=new J(e,this.shapesRepository);this.historyManager.execute(t)}}class _{constructor(e,t,s){i(this,"shape");i(this,"repository");i(this,"oldColor");i(this,"newColor");this.shape=e,this.repository=t,this.oldColor=e.color,this.newColor=s}execute(){this.shape.color=this.newColor,this.repository.notify()}undo(){this.shape.color=this.oldColor,this.repository.notify()}}class q{constructor(e,t,s){i(this,"shape");i(this,"repository");i(this,"oldColor");i(this,"newColor");i(this,"isLine");this.shape=e,this.repository=t,this.isLine=e instanceof l,this.isLine?this.oldColor=e.color:w(e)?this.oldColor=e.lineColor:this.oldColor="",this.newColor=s}execute(){this.isLine?this.shape.color=this.newColor:w(this.shape)&&(this.shape.lineColor=this.newColor),this.repository.notify()}undo(){this.isLine?this.shape.color=this.oldColor:w(this.shape)&&(this.shape.lineColor=this.oldColor),this.repository.notify()}}class z{constructor(e,t,s){i(this,"shape");i(this,"repository");i(this,"oldWidth");i(this,"newWidth");this.shape=e,this.repository=t,this.oldWidth=e.lineWidth,this.newWidth=s}execute(){this.shape.lineWidth=this.newWidth,this.repository.notify()}undo(){this.shape.lineWidth=this.oldWidth,this.repository.notify()}}class j{constructor(e,t,s,n){i(this,"shape");i(this,"repository");i(this,"oldWidth");i(this,"oldHeight");i(this,"newWidth");i(this,"newHeight");i(this,"isLine");i(this,"isRect");i(this,"isCircle");if(this.shape=e,this.repository=t,this.newWidth=s,this.newHeight=n,this.isLine=e instanceof l,this.isRect=f(e),this.isCircle=v(e),this.isLine){const o=e;this.oldWidth=Math.abs(o.x2-o.x),this.oldHeight=Math.abs(o.y2-o.y)}else if(this.isRect){const o=e;this.oldWidth=o.width,this.oldHeight=o.height}else if(this.isCircle){const o=e;this.oldWidth=o.radius*2,this.oldHeight=o.radius*2}else this.oldWidth=0,this.oldHeight=0}execute(){this.applyDimensions(this.newWidth,this.newHeight),this.repository.notify()}undo(){this.applyDimensions(this.oldWidth,this.oldHeight),this.repository.notify()}applyDimensions(e,t){if(this.isLine){const s=this.shape,n=s.x2-s.x>=0?1:-1,o=s.y2-s.y>=0?1:-1;s.x2=s.x+e*n,s.y2=s.y+t*o}else if(this.isRect){const s=this.shape;s.width=e,s.height=t}else if(this.isCircle){const s=this.shape;s.radius=Math.max(e,t)/2}}}class G{constructor(e,t){i(this,"shapesRepository");i(this,"historyManager");this.shapesRepository=e,this.historyManager=t}changeFillColor(e,t){const s=new _(e,this.shapesRepository,t);this.historyManager.execute(s)}changeStrokeColor(e,t){const s=new q(e,this.shapesRepository,t);this.historyManager.execute(s)}changeLineWidth(e,t){const s=new z(e,this.shapesRepository,t);this.historyManager.execute(s)}changeDimensions(e,t,s){const n=new j(e,this.shapesRepository,t,s);this.historyManager.execute(n)}}class V{constructor(){i(this,"undoStack",[]);i(this,"redoStack",[]);i(this,"undoButton",null);i(this,"redoButton",null);this.undoButton=document.getElementById("undo-btn"),this.redoButton=document.getElementById("redo-btn"),this.updateButtonStates()}execute(e){e.execute(),this.undoStack.push(e),this.redoStack=[],this.updateButtonStates()}undo(){const e=this.undoStack.pop();e&&(e.undo(),this.redoStack.push(e),this.updateButtonStates())}redo(){const e=this.redoStack.pop();e&&(e.execute(),this.undoStack.push(e),this.updateButtonStates())}canUndo(){return this.undoStack.length>0}canRedo(){return this.redoStack.length>0}clear(){this.undoStack=[],this.redoStack=[],this.updateButtonStates()}updateButtonStates(){this.undoButton&&(this.undoButton.disabled=!this.canUndo()),this.redoButton&&(this.redoButton.disabled=!this.canRedo())}}class Q{constructor(e,t,s,n){i(this,"shape");i(this,"repository");i(this,"dx");i(this,"dy");this.shape=e,this.repository=t,this.dx=s,this.dy=n}execute(){this.shape.move(this.dx,this.dy),this.repository.notify()}undo(){this.shape.move(-this.dx,-this.dy),this.repository.notify()}}class Z{constructor(e,t){i(this,"shapesRepository");i(this,"historyManager");this.shapesRepository=e,this.historyManager=t}execute(e,t,s){const n=new Q(e,this.shapesRepository,t,s);this.historyManager.execute(n)}executeById(e,t,s){const n=this.shapesRepository.get(e);n&&this.execute(n,t,s)}}class ee{constructor(e,t){i(this,"shape");i(this,"repository");this.shape=e,this.repository=t}execute(){this.repository.remove(this.shape.id)}undo(){this.repository.add(this.shape)}}class te{constructor(e,t){i(this,"shapesRepository");i(this,"historyManager");this.shapesRepository=e,this.historyManager=t}execute(e){const t=new ee(e,this.shapesRepository);this.historyManager.execute(t)}executeById(e){const t=this.shapesRepository.get(e);t&&this.execute(t)}}class se{constructor(e){i(this,"tools");i(this,"activeTool",null);i(this,"activeToolButton",null);this.tools=e}getActiveTool(){if(!this.activeTool)throw new Error("No active tool selected");return this.activeTool}setActiveTool(e){const t=this.tools[e];if(!t){console.error(`Tool ${e} not found`);return}this.activeTool&&this.activeTool.deactivate(),this.activeTool=t,this.activeTool.activate(),this.activeToolButton&&this.activeToolButton.classList.remove("active");const s=document.getElementById(`${e.toLowerCase()}-btn`);s&&(s.classList.add("active"),this.activeToolButton=s)}getTools(){return this.tools}}class ie{constructor(e,t){i(this,"shapesRepo");i(this,"renderingManager");this.shapesRepo=e,this.renderingManager=t,e.subscribe(()=>this.updateShapes()),this.renderingManager.startRendering()}updateShapes(){const e=this.shapesRepo.getAll();this.renderingManager.setShapes(e)}}class ne{constructor(e){i(this,"toolManager");this.toolManager=e,this.setupEventListeners()}setupEventListeners(){var e,t,s,n;(e=document.getElementById("select-btn"))==null||e.addEventListener("click",()=>{this.toolManager.setActiveTool("Select"),this.updateToolbarState("Select")}),(t=document.getElementById("rect-btn"))==null||t.addEventListener("click",()=>{this.toolManager.setActiveTool("Rect"),this.updateToolbarState("Rect")}),(s=document.getElementById("line-btn"))==null||s.addEventListener("click",()=>{this.toolManager.setActiveTool("Line"),this.updateToolbarState("Line")}),(n=document.getElementById("circle-btn"))==null||n.addEventListener("click",()=>{this.toolManager.setActiveTool("Circle"),this.updateToolbarState("Circle")})}updateToolbarState(e){document.querySelectorAll(".toolbar .tool").forEach(s=>{s.classList.remove("active")});const t=document.getElementById(`${e.toLowerCase()}-btn`);t&&t.classList.add("active")}}class oe{constructor(e,t,s){i(this,"shapesRepo");i(this,"renderingManager");i(this,"layersContainer");i(this,"removeShape");if(this.shapesRepo=e,this.renderingManager=t,this.removeShape=s,this.layersContainer=document.getElementById("layers-container"),!this.layersContainer){console.error("Контейнер для слоев не найден");return}e.subscribe(()=>this.updateLayers()),this.updateLayers()}updateLayers(){if(!this.layersContainer)return;this.layersContainer.innerHTML="";const e=this.shapesRepo.getAll(),t=this.renderingManager.selectedShape;if(e.length===0){const s=document.createElement("div");s.style.color="#999",s.style.fontSize="13px",s.style.textAlign="center",s.style.padding="20px 0",s.textContent="Нет объектов",this.layersContainer.appendChild(s);return}e.forEach(s=>{const n=document.createElement("div");n.className="layer-item",t&&t.id===s.id&&n.classList.add("selected");const o=document.createElement("span");o.className="layer-icon",s instanceof y?o.innerHTML='<svg viewBox="0 0 24 24" fill="currentColor"><path d="M19,3H5C3.9,3,3,3.9,3,5v14c0,1.1,0.9,2,2,2h14c1.1,0,2-0.9,2-2V5C21,3.9,20.1,3,19,3z M19,19H5V5h14V19z"></path></svg>':s instanceof m?o.innerHTML='<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12,2C6.48,2,2,6.48,2,12s4.48,10,10,10s10-4.48,10-10S17.52,2,12,2z M12,20c-4.42,0-8-3.58-8-8s3.58-8,8-8s8,3.58,8,8 S16.42,20,12,20z"></path></svg>':s instanceof l&&(o.innerHTML='<svg viewBox="0 0 24 24" fill="currentColor"><path d="M19,13H5v-2h14V13z"></path></svg>');const a=document.createElement("span");a.className="layer-name",a.textContent=this.getShapeName(s);const h=document.createElement("button");h.className="layer-delete-btn",h.innerHTML="×",h.title="Удалить",h.addEventListener("click",c=>{c.stopPropagation(),t&&t.id===s.id&&this.renderingManager.setSelectedShape(null),this.removeShape.execute(s)}),n.appendChild(o),n.appendChild(a),n.appendChild(h),n.addEventListener("click",()=>{const c=this.renderingManager.selectedShape;c&&c.id===s.id?this.renderingManager.setSelectedShape(null):this.renderingManager.setSelectedShape(s),this.updateLayers()}),this.layersContainer.insertBefore(n,this.layersContainer.firstChild)})}getShapeName(e){return e instanceof y?`Прямоугольник ${e.id.slice(0,4)}`:e instanceof m?`Круг ${e.id.slice(0,4)}`:e instanceof l?`Линия ${e.id.slice(0,4)}`:`Фигура ${e.id.slice(0,4)}`}}const C=document.getElementById("canvas");if(!C)throw new Error("Canvas element not found");const E=C.getContext("2d");if(!E)throw new Error("Could not get 2D context from canvas");const re=new W(E),u=new D(re),d=new H,S=new P(C),p=new V,M=new K(d,p),R=new te(d,p),ae=new Z(d,p),he=new G(d,p),ce={Select:new X(S,M,d,u,ae,he,R),Rect:new N(S,M,u),Line:new U(S,M,u),Circle:new A(S,M,u)},g=new se(ce);new ne(g);new ie(d,u);new oe(d,u,R);new F(C,d,p,u,g);const L=document.getElementById("undo-btn"),I=document.getElementById("redo-btn");L&&L.addEventListener("click",()=>{p.undo()});I&&I.addEventListener("click",()=>{p.redo()});document.addEventListener("keydown",r=>{(r.ctrlKey||r.metaKey)&&(r.key==="z"||r.keyCode===90)&&!r.shiftKey&&(r.preventDefault(),p.undo()),(r.ctrlKey||r.metaKey)&&(r.key==="z"||r.keyCode===90)&&r.shiftKey&&(r.preventDefault(),p.redo())});document.addEventListener("keydown",r=>{if(!(r.target instanceof HTMLInputElement||r.target instanceof HTMLTextAreaElement))switch(r.keyCode){case 83:g.setActiveTool("Select");break;case 82:g.setActiveTool("Rect");break;case 76:g.setActiveTool("Line");break;case 67:g.setActiveTool("Circle");break}});d.subscribe(()=>u.setShapes(d.getAll()));u.setShapes(d.getAll());u.startRendering();g.setActiveTool("Select");
